var k="post-message-action";function pe(e){return e.type===k&&typeof e.action=="object"}function R(e,t){function r(){return typeof e=="function"?e():e}function n(a){let s=r();!s||a.origin!==s.origin||a.source!==s||(pe(a.data)?t(a.data.action):console.warn("Unknown message received",a.data))}function i(){window.removeEventListener("message",n)}function o(a){let s=r();if(!s)return;let p={type:k,action:a};s.postMessage(p,s.origin)}return window.addEventListener("message",n),{dispose:i,sendAction:o}}var U="boolean",V="integer",F="float",N="string",v="input",L="dropdown",Y="checkbox";function ce(e){return function(r){return(r==null?void 0:r.type)===e}}function le(e){return function(r){let n=[e,r].join(" ");function i(o){return{type:n,payload:o}}return i.type=n,i.match=ce(n),i}}var de="[ext]",y=le(de),B=y("icons-loaded"),E=y("control-selected"),j=y("select-control"),H=y("delete-property-changes"),W=y("outline-changed"),G=y("change-property"),z=y("property-changed"),$=y("change-property-failed"),S=y("change-stack-modified");async function X(e){let t;try{t=await J(e)}catch{console.error(`Error in getting document for ${e}`)}return t}async function J(e){let t=await ge(e);if(t){let r=t.baseType;if(r){let n=await J(r);return Object.assign({},n,t.properties)}return Object.assign(Object.assign({},t.properties))}else return t}async function ge(e){let t,r={method:"GET",cache:"force-cache",headers:{"Content-Type":"application/xml"}},n;try{n=await fetch(jQuery.sap.getModulePath(e,".control"),r)}catch{console.error("Error in fetching control metadata")}if((n==null?void 0:n.status)===200){let i=await n.text(),a=new DOMParser().parseFromString(i,"application/xml");t=ue(a.documentElement,e)}return t}function ue(e,t){let r=e.children,n=ye(r),i={baseType:K(n,t),doc:fe(r),properties:{}},o=Ce(e.children,"properties"),a=o==null?void 0:o.children;return me(a).forEach(p=>{i.properties[p.propertyName]={...p}}),i}function ye(e){var n,i;let t=e.length,r="";for(let o=0;o<t;o++)if(e&&e.item(o)&&((n=e.item(o))==null?void 0:n.tagName)==="baseType"){r=((i=e.item(o))==null?void 0:i.innerHTML)||"";break}return r}function me(e){var r,n,i,o;let t=[];for(let a in e){let s={propertyName:"",type:"",defaultValue:"",description:"",propertyType:""},p=parseInt(a);s.propertyName=((r=e==null?void 0:e.item(p))==null?void 0:r.getAttribute("name"))||"",s.type=K(((n=e==null?void 0:e.item(p))==null?void 0:n.getAttribute("type"))||"string")||"",s.description=Q(((i=e==null?void 0:e.item(p))==null?void 0:i.textContent)||"")||"",s.defaultValue=((o=e==null?void 0:e.item(p))==null?void 0:o.getAttribute("defaultValue"))||"-",s.propertyType=Pe(s.type),t.push(s)}return t}function fe(e){return Q(he(e))}function Ce(e,t){var i;let r=e.length,n=null;for(let o=0;o<r;o++)if(e&&e.item(o)&&((i=e.item(o))==null?void 0:i.tagName)===t){n=e.item(o);break}return n}function he(e){var n,i;let t=e.length,r="";for(let o=0;o<t;o++)if(e&&e.item(o)&&((n=e.item(o))==null?void 0:n.tagName)==="documentation"){r=((i=e.item(o))==null?void 0:i.textContent)||"";break}return r}var q="boolean int float number function object string void any",Te=q+" Element Control Component";function K(e,t){if(!e)return"";if(e.indexOf("/")!==-1)return e.replace(/\//g,".");if(e.indexOf(".")===-1&&Te.indexOf(e)!==-1)return"sap.ui.core."+e;if(t)return t.split(".").slice(0,-1).concat([e.replace(/\//g,".")]).join(".")}function Q(e){let t=(e||"").split("<"),r="";for(let n of t)if(!r)r=n;else{let i=n.indexOf(">");r+=i>=0?n.substring(i+1):`<${n}`}return r}function Pe(e){if(e){let t=e.replace(/^sap\.ui\.core\./,"");return q.indexOf(t.replace("[]",""))!==-1?t:e}}function b(e){let t;return e.getElementInstance?t=e.getElementInstance():t=e.getElement(),t}var Z=e=>{let t=e.replace(/([A-Z])/g," $1");return t.charAt(0).toUpperCase()+t.slice(1)};function ve(e){let t=(e||"").toLowerCase();return t.indexOf("src")>=0||t.startsWith("icon")||t.endsWith("icon")}function Ee(e){let t={primitiveType:"any",ui5Type:null,enumValues:null,isArray:!1};if(!e)return;let r=e.getType();if(!r)return;let n=r.getName();if(!!n){if(n.indexOf("[]")>0)t.primitiveType=n.substring(0,n.indexOf("[]")),t.isArray=!0;else if(n==="void"||n==="object")t.primitiveType=n;else if(n==="any")t.primitiveType="any";else if(n==="boolean"||n==="string"||n==="int"||n==="float")t.primitiveType=n;else{let i=window.sap.ui.base.DataType,o=i.getType(n);if(o&&!(o instanceof i))return t;let a=Object.getPrototypeOf(o).getName();a?t.primitiveType=a:t.primitiveType="enum",t.ui5Type=n,t.primitiveType==="enum"&&(t.enumValues=jQuery.sap.getObject(t.ui5Type))}return t}}function be(e){return!(e.isArray||e.primitiveType==="any")}function xe(e){if(typeof e=="object"&&e instanceof Object&&!Array.isArray(e))try{return JSON.stringify(e)}catch(t){return t instanceof Error&&t.message.toLowerCase().includes("converting circular structure to json")?"<Circular JSON cannot be displayed>":e}else return typeof e=="function"?"":e}async function m(e,t,r=!0){let n=e.getMetadata(),i=n.getName(),o=sap.ui.fl.Utils.checkControlId(e),a=t?t.getDesignTimeMetadata().getData().properties:void 0,s=n.getAllProperties(),p=Object.keys(s),c=[],d=r?await X(i):{};for(let g of p){let l=s[g],u=Ee(l);if(!u)continue;let _=!1;a&&a[l.name]&&(_=a[l.name].ignore);let O={id:e.getId(),name:l.name,newValue:e.getProperty(l.name)},P=e.getBindingInfo(O.name);(P==null?void 0:P.bindingString)!==void 0&&(O.newValue=P.bindingString);let f=((t==null?void 0:t.isSelectable())??!1)&&be(u)&&o&&!_,C=xe(O.newValue),ae=ve(l.name)&&i!=="sap.m.Image"&&u.ui5Type==="sap.ui.core.URI",h=d&&d[l.name]?d[l.name]:{defaultValue:l.defaultValue||"-",description:"",propertyName:l.name,type:u.ui5Type,propertyType:u.ui5Type},T=Z(l.name);switch(u.primitiveType){case"enum":{let M=u.enumValues??{},se=Object.keys(M).map(D=>({key:D,text:M[D]}));c.push({type:N,editor:L,name:l.name,readableName:T,value:C,isEnabled:f,options:se,documentation:h});break}case"string":{c.push({type:N,editor:v,name:l.name,readableName:T,value:C,isEnabled:f,isIcon:ae,documentation:h});break}case"int":{c.push({type:V,editor:v,name:l.name,readableName:T,value:C,isEnabled:f,documentation:h});break}case"float":{c.push({type:F,editor:v,name:l.name,readableName:T,value:C,isEnabled:f,documentation:h});break}case"boolean":{c.push({type:U,editor:Y,name:l.name,readableName:T,value:C,isEnabled:f,documentation:h});break}}}return{id:e.getId(),type:i,properties:c.sort((g,l)=>g.name>l.name?1:-1),name:i}}var ee=async(e="")=>{let t=!1,r=sap.ui.getCore().byId(e);if(r){let n=sap.ui.dt.OverlayRegistry.getOverlay(r);if((!n||!n.getDomRef())&&(n=sap.ui.dt.OverlayUtil.getClosestOverlayFor(r)),n){let i=b(n);t=(await m(i,n,!1)).properties.find(s=>s.isEnabled===!0)!==void 0}}else{let n=sap.ui.getCore().getComponent(e);if(n){let o=(await m(n,void 0,!1)).properties.find(a=>a.isEnabled===!0);t=!1}}return t};async function w(e,t){let r=[...e],n=[];for(;r.length;){let i=r.shift(),o=await ee(i==null?void 0:i.id);if((i==null?void 0:i.type)==="element"){let a=(i.elements??[]).flatMap(c=>c.type==="aggregation"?c.elements??[]:[]),{text:s}=t(i.id),p={controlId:i.id,controlType:i.technicalName,name:s??i.technicalName.split(".").slice(-1)[0],editable:o,visible:i.visible??!0,children:await w(a,t)};n.push(p)}}return n}async function te(e,t){let r=await e.getService("outline");async function n(){let i=await r.get(),o=await w(i,a=>{let s=sap.ui.getCore().byId(a);if(s&&s.getMetadata().getProperty("text")){let p=s.getProperty("text");return typeof p=="string"&&p.trim()!==""?{text:p}:{}}return{}});t(W(o))}r.attachEvent("update",n)}function ne(){return{getControlById:Ie,getIcons:we,getComponent:Oe,getOverlay:Ne,getClosestOverlayFor:Se}}function Ie(e){return sap.ui.getCore().byId(e)}function Oe(e){return sap.ui.getCore().getComponent(e)}function Ne(e){return sap.ui.dt.OverlayRegistry.getOverlay(e)}function Se(e){return sap.ui.dt.OverlayUtil.getClosestOverlayFor(e)}function we(){return sap.ui.core.IconPool.getIconNames("undefined").map(e=>{let t=sap.ui.core.IconPool.getIconInfo(e);return{name:e.toLowerCase(),content:t.content,fontFamily:t.fontFamily}}).sort((e,t)=>e.name<t.name?-1:e.name>t.name?1:0)}function A(e){let t={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)};fetch("./control-property-editor/report-telemetry",t).then(async r=>{console.log(r)}).catch(r=>{console.error("There was an error!",r)})}var x=class{constructor(t,r){this.rta=t;this.ui5=r;this.appliedChangeCache=new Map;this.activeChangeHandlers=new Set}init(t,r){let n=new Set;this.rta.attachSelectionChange(this.createOnSelectionChangeHandler(t,n)),r(async i=>{if(j.match(i)){let o=i.payload,a=this.ui5.getControlById(o);if(!a){let c=this.ui5.getComponent(o);if(c){let d=await m(c),g=E(d);t(g)}return}n.add("outline");let s=this.ui5.getOverlay(a),p=this.rta.getSelection();if(p.length>0)for(let c=0;c<p.length;c++)p[c].setSelected(!1);if((!s||!s.getDomRef())&&(s=this.ui5.getClosestOverlayFor(a)),s&&s.isSelectable())s.setSelected(!0);else{let c=await m(a),d=E(c);t(d)}}})}applyControlPropertyChange(t,r){let n=oe(t,r);this.appliedChangeCache.set(n,Date.now())}createOnSelectionChangeHandler(t,r){return async n=>{let i=n.getParameter("selection");for(let o of this.activeChangeHandlers)o();if(this.activeChangeHandlers.clear(),Array.isArray(i)&&i.length===1){let o=this.ui5.getControlById(i[0].getId());if(o){let a=b(o),s=a.getMetadata().getName();this.handlePropertyChanges(a,t);try{let p=r.has("outline"),c=s.toLowerCase().startsWith("sap")?s:"Other Control Types";p?A({category:"Outline Selection",controlName:c}):A({category:"Overlay Selection",controlName:c})}catch(p){console.error("Error in reporting telemetry",p)}finally{let p=await m(a,o),c=E(p);t(c),r.delete("outline")}}}}}handlePropertyChanges(t,r){let n=i=>{let o=i.getParameter("name"),a=i.getParameter("id"),s=oe(a,o);if(this.appliedChangeCache.get(s)){this.appliedChangeCache.delete(s);return}let c=t.getBindingInfo(o),d=(c==null?void 0:c.bindingString)??i.getParameter("newValue"),g=z({controlId:a,propertyName:o,newValue:d});r(g)};t.attachEvent("_change",n),this.activeChangeHandlers.add(()=>{try{t.detachEvent("_change",n)}catch{}})}};function oe(e,t){return[e,t].join(",")}var Ae="FE_FROM_SCRATCH";async function ie(e,t){let{layer:r,componentId:n,rta:i,generator:o}=e,a=sap.ui.getCore().byId(t.controlId);if(!a)return;let s={layer:r,developerMode:!0,baseId:n,projectId:"",scenario:Ae,generator:o},p=typeof t.value=="string"&&re(t.value)?"BindProperty":"Property",c=typeof t.value=="string"&&re(t.value)?{generator:o,propertyName:t.propertyName,newBinding:t.value}:{generator:o,propertyName:t.propertyName,newValue:t.value},d=await sap.ui.rta.command.CommandFactory.getCommandFor(a,p,c,null,s);await i.getCommandStack().pushAndExecute(d)}function re(e){return e.includes("{")&&e.includes("}")}var I=class{constructor(t,r,n){this.options=t;this.ui5=r;this.selectionService=n;this.savedChanges=[]}async init(t,r){r(async o=>{if(G.match(o))try{this.selectionService.applyControlPropertyChange(o.payload.controlId,o.payload.propertyName),await ie(this.options,o.payload)}catch(a){let s="",p=o.payload.controlId||"",c=this.ui5.getControlById(p);c&&(s=c.getMetadata().getName());let g=_e(a==null?void 0:a.toString(),p,s)||`RTA Exception applying expression "${o.payload.value}"`,l=$({...o.payload,errorMessage:g});t(l)}else H.match(o)&&await this.deleteChange(o.payload.controlId,o.payload.propertyName,o.payload.fileName)});let n=await fetch(`/FioriTools/api/getChanges?_=${Date.now()}`).then(o=>o.json()).catch(console.error),i=Object.keys(n??{}).map(o=>{let a=n[o];try{if(Me(["fileName","selector.id","content.property","creation"],a),[a.content.newValue,a.content.newBinding].every(s=>s==null))throw new Error("Invalid change, missing new value in the change file");return{type:"saved",kind:"valid",fileName:a.fileName,controlId:a.selector.id,propertyName:a.content.property,value:a.content.newValue??a.content.newBinding,timestamp:new Date(a.creation).getTime(),controlName:a.selector.type.split(".").pop()}}catch(s){if(a.fileName){let p={type:"saved",kind:"unknown",fileName:a.fileName};return a.creation&&(p.timestamp=new Date(a.creation).getTime()),p}console.error(s);return}}).filter(o=>!!o).sort((o,a)=>a.timestamp-o.timestamp);this.savedChanges=i,t(S({saved:i,pending:[]})),this.options.rta.attachUndoRedoStackModified(this.createOnStackChangeHandler(t))}async deleteChange(t,r,n){let i=this.savedChanges.filter(o=>n?n===o.fileName:o.controlId===t&&o.propertyName===r).map(o=>fetch("/FioriTools/api/removeChanges",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({fileName:o.fileName})}));await Promise.all(i).catch(console.error)}createOnStackChangeHandler(t){return async()=>{let r=this.options.rta.getCommandStack(),n=r.getCommands(),i=r.getAllExecutedCommands(),o=n.length-i.length,a=n.map(function(s,p){try{let c=s.getProperty("selector"),d=s.getProperty("changeType"),g="";switch(d){case"propertyChange":g=s.getProperty("newValue");break;case"propertyBindingChange":g=s.getProperty("newBinding");break}return{type:"pending",controlId:c.id,propertyName:s.getProperty("propertyName"),isActive:p>=o,value:g,controlName:s.getElement().getMetadata().getName().split(".").pop()??""}}catch(c){console.error(c)}}).filter(s=>!!s);t(S({saved:this.savedChanges,pending:a}))}}};function _e(e,t,r){return e.replace("Error: Applying property changes failed:","").replace(`${r}#${t}`,"")}function Me(e,t){for(let r of e){let n=De(r,t);if(n==null)throw new Error(`Invalid change, missing ${r} in the change file`)}}function De(e,t){let r=e.split("."),n=t;for(let i of r)n=n[i];return n}function ke(e){console.log("Initializing Control Property Editor");let{rta:t}=e,r=ne(),n=[];function i(p){n.push(p)}let o=new x(t,r),a=new I(e,r,o),s=[o,a];try{let{sendAction:p}=R(window.parent,async function(g){for(let l of n)try{await l(g)}catch(u){console.error(u)}});for(let d of s)d.init(p,i);te(t,p);let c=r.getIcons();p(B(c))}catch(p){console.error("Error during initialization of Control Property Editor",p)}}export{ke as init};
//# sourceMappingURL=ui5-adaptation.js.map
